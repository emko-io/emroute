# v1.0.0-beta.6 Issues

536 unit tests pass. Type checking passes. Formatting clean. Lint clean.

---

## Bugs

### #1 SPA: rapid navigation race condition — wrong page can render

`src/renderer/spa/html.renderer.ts:172-245`

`handleNavigation` has no cancellation mechanism. If the user clicks rapidly
between routes, multiple renders run concurrently. The last one to _complete_
(not the last one _initiated_) wins the DOM, so a slow earlier navigation can
overwrite a fast later one.

Other routers solve this with an AbortController per navigation — abort the
previous before starting the next.

### #2 ~~SSR: file fetches in `buildComponentContext` are sequential, not parallel~~ — RESOLVED

`src/route/route.core.ts:228-263`

HTML, MD, and CSS companion files are fetched one after another with three
separate `await fetch()` calls. They are independent and could be fetched in
parallel with `Promise.all`, reducing SSR latency for routes with multiple
companion files.

Same issue in `loadWidgetFiles` at lines 209-220.

> **Resolution:** `buildComponentContext` now uses `Promise.all` for parallel
> fetches. `loadWidgetFiles` also uses `Promise.all` (with stale `result`
> variable cleaned up). Mitigated further by caching.

### #3 ~~Widget CSS duplicated when widget appears multiple times on a page~~ — WONT-FIX

`src/component/widget.component.ts:32`

`renderHTML` prepends `<style>${files.css}</style>` on every call. If a widget
is used three times on one page, the same CSS block is injected three times.
There is no deduplication.

> **Resolution:** Widgets are self-contained units that own their markup
> including styles. Duplication is an acceptable trade-off.

### #4 ~~`page-title` widget: side effect in render function~~ — WONT-FIX

`src/widget/page-title.widget.ts:34`

`renderHTML` mutates `document.title` as a side-effect of rendering. During SSR,
the `typeof document !== 'undefined'` guard prevents a crash, but
`resolveWidgetTags` in the SSR HTML renderer still calls `renderHTML` — meaning
the guard is the only thing between this and a server-side error.

Render functions should be pure. The title-setting behavior should live in the
custom element's `connectedCallback` (browser only), not in `renderHTML` (called
everywhere).

> **Resolution:** Widgets are side-effectful by design (see issue #10 / ADR
> discussion). The `typeof document !== 'undefined'` guard is sufficient for
> SSR safety.

### #5 ~~SSR: query string stripped — not passed to components~~ — RESOLVED

`src/renderer/ssr/html.renderer.ts:67-73` and `src/renderer/ssr/md.renderer.ts:52-55`

Both SSR renderers extract only `pathname` from the URL and discard query
parameters entirely. `buildComponentContext` and `getData` never see query
strings. Components that need query params for filtering, pagination, or search
will silently produce wrong results in SSR.

> **Resolution:** Added `searchParams?: URLSearchParams` to `MatchedRoute` and
> `ComponentContext`. `RouteMatcher.match()` now captures search params from the
> URL. All three renderers (SPA, SSR HTML, SSR MD) preserve the query string
> when building `matchUrl` and thread `matched.searchParams` through to
> `buildComponentContext`. Components can now access `context.searchParams` in
> `getData()` and render methods.

### #6 Dev server: hardcoded 2-second sleep for initial bundle

`server/dev.server.ts:257`

```ts
await new Promise((resolve) => setTimeout(resolve, 2000));
```

This is a race condition workaround — on fast machines the sleep is wasted, on
slow or cold-cache machines the bundle may not be ready. A watch-based approach
(wait for the output file to exist) would be more reliable.

---

## Dead code / lint

### #7 ~~`src/route/router.ts` is dead code~~ — RESOLVED

Not exported from `src/index.ts`, `src/renderer/spa/mod.ts`, or any `deno.json`
export. It re-exports `SpaHtmlRouter` as `Router` for backward compatibility,
but nothing imports it. Can be removed.

> **Resolution:** Deleted.

### #8 ~~Unused `FileSystemError` import in route generator~~ — RESOLVED

`tool/route.generator.ts:37`

`FileSystemError` is imported but only used via the re-export at line 405. The
import on line 37 is redundant since the re-export (`export { FileSystemError }
from './fs.type.ts'`) doesn't need it.

> **Resolution:** Removed redundant import.

### #9 ~~Lint: unused variables~~ — RESOLVED

| File                              | Line | Symbol                            |
| --------------------------------- | ---- | --------------------------------- |
| `tool/route.generator.ts`         | 37   | `FileSystemError` import (see #8) |
| `test/browser/hydration.test.ts`  | 50   | `ssrTimestamp`                    |
| `test/unit/widget.file.test.ts`   | 161  | `AbsoluteUrlWidget`               |
| `test/unit/widget.parser.test.ts` | 4    | `assertIsError` import            |
| `test/unit/page.core.test.ts`     | 26   | `assertIsError` import            |

> **Resolution:** Removed unused imports (`assertIsError`, `RenderContext`),
> prefixed intentionally-unused vars with `_` (`ssrTimestamp`, `router`,
> `response`), deleted unused test class (`AbsoluteUrlWidget`).

### #10 ~~Lint: `require-await` warnings~~ — RESOLVED

Async functions/methods that don't await anything. The bulk are `getData()`
overrides and mock `loadFiles` arrows in test files — inherently async for the
interface but synchronous in the test. One is in production code:
`tool/route.generator.ts`.

> **Resolution:** Removed `async` from 42 methods/functions that don't `await`.
> Wrapped their return values in `Promise.resolve()` (or `Promise.reject()` for
> throw cases) to preserve the return type contract.

---

## Design notes (non-blocking)

### #11 `MarkdownElement.deriveMarkdownPath` only tries flat file path

`src/element/markdown.element.ts:100-117`

For `/about`, it returns `/routes/about.page.md`. If the real file is
`routes/about/index.page.md`, the first fetch fails before `getAlternativePath`
is tried. Works correctly but wastes a network round-trip per mismatched path.

### #12 SSR hydration only at top-level slot

The `data-ssr-route` attribute is only set on the top-level `<router-slot>`.
Nested router-slots in parent layouts don't carry this hint, so child content
in a nested layout will be re-rendered by the SPA even when SSR already rendered
it.

### #13 `DefaultPageComponent` exported as module-level instance

`src/component/page.component.ts:12` — `export default new DefaultPageComponent()`.
Same pattern for `pageTitleWidget` and `breadcrumbWidget`. These are stateless
objects used as defaults, so it's functionally harmless, but the pattern is
module-level singletons.

### #14 `resolveWidgetTags` regex uses `[^]*?` (V8-specific)

`src/util/html.util.ts:100`

`[^]*?` (match any character including newlines) is a V8/Deno extension, not
standard ECMAScript. Equivalent portable pattern is `[\s\S]*?`. Not a problem
as long as the project targets Deno exclusively, but a portability concern if
the package is ever consumed in non-V8 environments.

### #15 No navigation abort signal propagation

`SpaHtmlRouter` creates one `AbortController` at `initialize()` for the
lifetime of the router, but individual navigations don't get their own signals.
`getData()` receives `context.signal` from `buildComponentContext`, but this
is `undefined` in SPA mode (signal is only available for widget data loading in
`ComponentElement`). Long-running `getData()` calls can't be cancelled.

Related to #1 — both would be solved by per-navigation AbortControllers.
